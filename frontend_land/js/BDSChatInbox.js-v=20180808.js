var chatServerUrl="";var senderId="";var senderName="";var productId=0;var chatPK="";BDSChatInbox=new function(){var a=0;var m=[];var p={Year:"year",Month:"month",Day:"day",Hour:"hour",Minute:"minute",Second:"second"};var j="https://content.batdongsan.com.vn/trang-ca-nhan/HandlerWeb/ChatHandler.ashx";var d="chat-time-";var f="https://file4.batdongsan.com.vn/images/no-avatar.png";var g="https://file4.batdongsan.com.vn/images/no-photo.jpg";var h="https://file4.batdongsan.com.vn/images/support-avatar.png";var c="https://content.batdongsan.com.vn/Modules/Chats/scripts/ChatSound.mp3";var l=60;var k=true;var n=1;var e=0;var b;var i={handle:"#etoggle",dir:"https://file4.batdongsan.com.vn/images/emoticons/",label:"On Emoticons",style:"background: #eee",css:"class2"};window.onbeforeunload=function(){if(a>0){BDSChatInbox.closeAllRoom()}};this.attachEvents=function(){BDSChatInbox.addChatContainer();var q=this;if($.connection!=null){$.connection.hub.url=chatServerUrl+"/signalr/hubs";$.connection.hub.qs="__ui="+encodeURIComponent(senderId)+"&__un="+encodeURIComponent(senderName);b=$.connection.chatServer;$.connection.hub.start({transport:"auto"},function(){}).fail(function(){}).done(function(){BDSChatInbox.requestInboxRooms()});b.client.initiateChatUI=function(s,x,w,z){if(e!=0&&e!=s.chatRoomId){return}var t=$("#chatRoom-"+s.chatRoomId);if(m[s.chatRoomId]!=undefined){}else{var A=s.toUserId!=senderId?s.toUserId:s.fromUserId;m[s.chatRoomId]={popup:null,oldTime:null,lastTime:null,toUserId:A,avatarUrl:null,fileId:null,productId:s.productId,isLoadHistory:true};var v=$(strNewChatroomTemplate).tmpl(s);var r=$(strNewChatHeader).tmpl(s);var u=v.find(".chatMessages");a++;if(s.productId>0){BDSChatInbox.loadProductDetail(u,s,x);u.css("height",262)}else{if(BDSChatInbox.loadSupportDetail(u,s,x)){r.find(".user-status").css("display","none");r.find(".user-status").after($("<span />").addClass("link-chat-bds-header"));r.addClass("chat-header-bds");u.css("height",262)}else{u.css("height",365)}}if(x){r.find(".user-status").addClass("online-status");r.find(".link-chat-bds-header").removeClass("offline-status")}else{r.find(".user-status").removeClass("online-status");r.find(".link-chat-bds-header").addClass("offline-status")}BDSChatInbox.addChatArea(s.chatRoomId,r,BDSChatInbox.getFullName(s.chatUsers),v);m[s.chatRoomId].isLoadHistory=false;BDSChatInbox.requestHistory(s.chatRoomId);$("#newmessage-"+s.chatRoomId).focus(function(){if(!$(this).hasClass("text-focus")){$(this).addClass("text-focus")}b.server.updateReadMessage(s.chatRoomId)});$("#newmessage-"+s.chatRoomId).blur(function(){if($(this).hasClass("text-focus")){$(this).removeClass("text-focus")}});$("#messages-"+s.chatRoomId).scroll(function(){if($(this).scrollTop()==0){var B=parseInt($(this).attr("id").split("-")[1]);if(m[B].isLoadHistory){BDSChatInbox.requestHistory(B)}}return false});$("#sendmessage-"+s.chatRoomId).keypress(function(B){if((B.which&&B.which==13)||(B.keyCode&&B.keyCode==13)){$("#chatsend-"+s.chatRoomId).click();return false}});$("#pnlEmoticions-"+s.chatRoomId).click(function(B){var D=$(this).offset();var E=$(this).outerWidth();var C=$(this).outerHeight();$(".emoticons").attr("rel",s.chatRoomId).css({position:"absolute",top:(D.top-$(".emoticons").outerHeight())+"px",left:(D.left-$(".emoticons").outerWidth()+E)+"px"});B.stopPropagation();showIconTable()});if(!x&&w!=null){var y=$("#newmessage-"+s.chatRoomId);y.val("Liên hệ với khách hàng qua SĐT: "+w.Phone+" hoặc qua email "+w.Email);y.prop("disabled",true);y.css({"background-color":"#fff","font-style":"italic"});autoResizeTextArea(y)}}};b.client.receiveChatMessage=function(r,s,w){BDSChatInbox.updateLastestMessage(r,s,w);if(m[s.chatRoomId]==undefined){return}var t=$("#chatRoom-"+r.chatRoomId);var u=$("#messages-"+r.chatRoomId);BDSChatInbox.processDatetime(r,u);var v;if(senderId==r.senderId){v=$(strNewMessageTemplateRight).tmpl(r).appendTo(u)}else{v=$(strNewMessageTemplateLeft).tmpl(r).appendTo(u);BDSChatInbox.getAvatar(r,s,v);b.server.updateReadMessage(s.chatRoomId);if(k){BDSChatInbox.playSound()}}if(typeof(v)!="undefined"){v.emoticons(i)}u.scrollTop(u[0].scrollHeight)};b.client.receiveLeftChatMessage=function(r){};b.client.receiveEndChatMessage=function(r){a--};b.client.updateOnlineContacts=function(r){BDSChatInbox.updateStatusUserForRoom(r,true);BDSChatInbox.updateStatus(r,true)};b.client.updateOfflineContacts=function(r){BDSChatInbox.updateStatusUserForRoom(r,false);BDSChatInbox.updateStatus(r,false)};b.client.receiveErrorMessage=function(u){if(u.roomId!==undefined&&u.roomId.toString().length!=0){var r=$("#messages-"+u.chatRoomId);var s=$(strChatMessageErrorTemplate).tmpl(u);r.after(s);var t=s.height()+1;r.css("height",r.height()-t);setTimeout(function(){s.remove();r.css("height",r.height()+t)},3000)}else{alert(u.messageText)}};b.client.receiveHistoryMessage=function(r,s,t){if(r.length>0){for(var u=0;u<r.length;u++){BDSChatInbox.loadChatHistoryMessage(r[u],s,t)}if(m[s.chatRoomId].isLoadHistory==false){m[s.chatRoomId].isLoadHistory=true;if($("#messages-"+s.chatRoomId)[0]!=undefined){$("#messages-"+s.chatRoomId).scrollTop($("#messages-"+s.chatRoomId)[0].scrollHeight)}}else{$("#messages-"+s.chatRoomId).scrollTop(50)}}else{m[s.chatRoomId].isLoadHistory=false}};b.client.receiveSupporter=function(r){};b.client.receiveInboxRooms=function(r){BDSChatInbox.initInbox(r)};b.client.deleteMessage=function(s){var r=$("#messages-"+s+" .message:not(#m-0)");if(r.length>0){r.remove()}var t=$("#messages-"+s+" .chat-time");if(t.length>0){t.remove();m[s].oldTime=null;m[s].lastTime=null}alert("Tin nhắn đã được xóa.")};b.client.updateReadMessage=function(s){var v=$("#chat-inbox-room-"+s);if(v.hasClass("unread")){v.removeClass("unread");var r=$(".chat-inbox-count-read span");r.text("("+(parseInt(r.text().substring(1,r.text().length-1))+1)+")");var u=$(".chat-inbox-count-unread span");u.text("("+(parseInt(u.text().substring(1,u.text().length-1))-1)+")");if(n==2||n==3){BDSChatInbox.filterChatRoom()}}var t=$("#chat-inbox-room-unread-"+s);if(t.length>0){t.text("");t.attr("totalunread",0)}}}};this.sendChatMessage=function(r){var s=$("#newmessage-"+r);if(s.val()==null||s.val().trim()==""){return}var q={chatRoomId:r,messageText:$("<div />").text(s.val()).html().replace(/\n/g,"<br>")};s.val("");s.focus();try{b.server.sendChatMessage(q).fail(function(u){alert(u)})}catch(t){}return false};this.closeRoom=function(q){delete m[parseInt(q)];BDSChatInbox.endChat(q.toString())};this.endChat=function(r){var s=$("#newmessage-"+r);var q={senderId:senderId,senderName:senderName,chatRoomId:r,messageText:s.val()};s.val("");s.focus();b.server.endChat(q).fail(function(t){})};this.initiateChat=function(r,q){if(b==null){alert("Problem in connecting to Chat Server. Please Contact Administrator!");return}b.server.initiateChat(q,r).fail(function(s){alert(s)})};this.formatName=function(q,r){var s=this.subWords(q,r);return'<span title="'+q+'">'+s+"</span>"};this.isCurrentUser=function(q){return q==senderId};var o=[" ","-"];this.subWords=function(s,t){if(s.length<=t||t<=0){return s}var u;if(o.indexOf(s[t])!=-1){u=s.substring(0,t)}else{var r=t;var q="";while(r-->=0){if(o.indexOf(s[r])!=-1){break}}if(r==0){u=s.substring(0,t)}else{u=s.substring(0,r).trim()}}return u+"..."};this.subString=function(q,r){if(q.length<=r||r<=0){return q}var s=q.substring(0,r-3);return s+"..."};this.updateStatusUserForRoom=function(v,q){if(m!=undefined&&m!=null){var r=e;if(m[r]!=undefined&&m[r].toUserId!=undefined){if(m[r].toUserId==v.UserId){var s=$("#chatRoomHeader-"+r+" .user-status");var t=$("#chatRoomHeader-"+r+" .link-chat-bds-header");var u=$("#chatRoom-"+r+" .support-online-text");if(q){s.addClass("online-status");t.removeClass("offline-status");if(u.length>0){u.text("Sẵn sàng hỗ trợ")}}else{s.removeClass("online-status");t.addClass("offline-status");if(u.length>0){u.text("Đang offline")}}if(m[r].popup!=null){m[r].popup.updateStatusExternal(r,q)}}}}};this.getFullName=function(r){for(var q=0;q<r.length;q++){if(r[q].UserId!=senderId){return BDSChatInbox.subWords(r[q].FullName,30)}}return""};this.convertDatetimeToString=function(r,y){var z=r.getFullYear();var w=r.getMonth()+1;var s=r.getDate()<10?("0"+r.getDate()):r.getDate();var u=r.getHours();var t=u%12==0&&u>0&&u!=24?12:u%12;var v=r.getMinutes()<10?("0"+r.getMinutes()):r.getMinutes();var x=r.getSeconds()<10?("0"+r.getSeconds()):r.getSeconds();var q=u>12?" PM":" AM";if(y==p.Second){return t+":"+v+":"+x+q}else{if(y==p.Minute){return t+":"+v+q}else{if(y==p.Hour){return t+":"+v+q}else{if(y==p.Day){return t+":"+v+q+" "+s+" tháng "+w}else{if(y==p.Month){return t+":"+v+q+" "+s+" tháng "+w}else{if(y==p.Year){return t+":"+v+q+" "+s+" tháng "+w+" năm "+z}}}}}}return t+":"+v+" "+s+" tháng "+w};this.processDatetime=function(q,r){var s=new Date(q.timestamp);var t=false;var u=p.Hour;if(m[q.chatRoomId].lastTime==null){m[q.chatRoomId].lastTime=s;t=true}else{if(s.getFullYear()>m[q.chatRoomId].lastTime.getFullYear()){this.removeTimeMessage(p.Hour,r);this.removeTimeMessage(p.Day,r);this.removeTimeMessage(p.Month,r);t=true}else{if(s.getMonth()>m[q.chatRoomId].lastTime.getMonth()){this.removeTimeMessage(p.Hour,r);this.removeTimeMessage(p.Day,r);t=true}else{if(s.getDate()>m[q.chatRoomId].lastTime.getDate()){this.removeTimeMessage(p.Hour,r);t=true}else{if(s>(new Date(m[q.chatRoomId].lastTime.getTime()+(l*60*1000)))){t=true}}}}}if(t){m[q.chatRoomId].lastTime=s;this.addTimeMessage(s,u,r,true)}};this.addTimeMessage=function(r,u,q,s,t){if(s){q.append("<div class='chat-time chat-time-"+u+"' timestamp='"+r.getTime()+"'><div><span>"+this.convertDatetimeToString(r,u)+"</span></div></div>")}else{if(t.length==0){q.prepend("<div class='chat-time chat-time-"+u+"' timestamp='"+r.getTime()+"'><div><span>"+this.convertDatetimeToString(r,u)+"</span></div></div>")}else{t.after("<div class='chat-time chat-time-"+u+"' timestamp='"+r.getTime()+"'><div><span>"+this.convertDatetimeToString(r,u)+"</span></div></div>")}}};this.removeTimeMessage=function(t,q){q.find("."+d+t+":gt(0)").remove();var s=t;if(t==p.Hour){s=p.Day}else{if(t==p.Day){s=p.Month}else{if(t==p.Month){s=p.Year}}}var r=q.find("."+d+t);r.find("span").text(this.convertDatetimeToString(new Date(parseInt(r.attr("timestamp"))),s));r.removeClass(d+t).addClass(d+s)};this.getAvatar=function(q,r,u){var s="";var v=null;for(var t=0;t<r.chatUsers.length;t++){if(r.chatUsers[t].UserId!=senderId){s=r.chatUsers[t].Avatar}}if(m[r.chatRoomId].avatarUrl!=null&&q!=null){this.updateAvatar(m[r.chatRoomId].avatarUrl,r.chatRoomId,u)}else{$.ajax({url:j+"?action=getavatar&fileid="+(s==null?"":s),success:function(x){var w=f;if(x.avatarUrl.length>0){w=x.avatarUrl}m[r.chatRoomId].avatarUrl=w;if(q!=null){BDSChatInbox.updateAvatar(w,r.chatRoomId,u)}}})}};this.updateAvatar=function(q,u,t){var s=t.find(".avatar img");var r=document.createElement("img");$(r).attr("src",q);$(r).error(function(){q=f;m[u].avatarUrl=f;t.find(".avatar img").attr("src",q)});s.attr("src",q)};this.highlightChatRoom=function(q){if(!$("#newmessage-"+q).hasClass("text-focus")){$("#chatPopup-"+q+" .chatPopup-header").toggleClass("header-blink");if(typeof(m[q])!="undefined"&&m[q].highLightFunc!=null){clearTimeout(m[q].highLightFunc)}if(typeof(m[q])!="undefined"){m[q].highLightFunc=setTimeout('BDSChatInbox.highlightChatRoom("'+q+'");',1000)}}else{if($("#chatPopup-"+q+" .chatPopup-header").hasClass("header-blink")){$("#chatPopup-"+q+" .chatPopup-header").removeClass("header-blink")}}};this.loadProductDetail=function(r,q,s){$.ajax({url:j+"?action=getproduct&productId="+q.productId,success:function(t){if(t.success){var v=$(strChatProductDetailsTemplate).tmpl(t.product);r.before(v);var u=v.find("img");u.error(function(){u.attr("src",g)});v.find(".room-product-info-content").css({width:"320px"});if(t.product.UserId!=senderId){if(s){BDSChatInbox.displayWelComeMessage(r,q,"Rất vui vì bạn đã quan tâm đến tin rao của chúng tôi. Nếu có gì cần tư vấn hoặc giải đáp thì liên hệ với tôi!")}else{BDSChatInbox.displayWelComeMessage(r,q,"Rất vui vì bạn đã quan tâm đến tin rao của chúng tôi. Hiện tôi đang không online, vui lòng để lại tin nhắn cho tôi")}}}}})};this.displayWelComeMessage=function(s,r,u){var t;var q={chatMessageId:0,messageText:u};t=$(strNewMessageTemplateLeft).tmpl(q);s.prepend(t);BDSChatInbox.getAvatar(q,r,t);if(typeof(t)!="undefined"){t.emoticons(i)}};this.loadSupportDetail=function(r,q,t){var v=q.toUserId!=senderId?q.toUserId:q.fromUserId;for(var s=0;s<q.chatUsers.length;s++){if(q.chatUsers[s].UserId==v){if(q.chatUsers[s].IsStaff){var u=$(strChatCallerBdsTemplate).tmpl({userId:v,FullName:q.chatUsers[s].FullName,OnlineText:(t?"Sẵn sàng hỗ trợ":"Đang offline")});r.before(u);$.ajax({url:j+"?action=getavatar&fileid="+(q.chatUsers[s].Avatar==null?"":q.chatUsers[s].Avatar),success:function(x){var w=h;if(x.avatarUrl.length>0){w=x.avatarUrl}m[q.chatRoomId].fileId=q.chatUsers[s].Avatar;m[q.chatRoomId].avatarUrl=w;var y=u.find(".support-avatar");y.attr("src",w);y.error(function(){m[q.chatRoomId].avatarUrl=h;y.attr("src",h)})}});if(t){this.displayWelComeMessage(r,q,"Rất vui vì đã ghé thăm Batdongsan.com.vn. Bạn có cần tư vấn hoặc giải đáp thắc mắc gì, hãy chat với chúng tôi!")}else{this.displayWelComeMessage(r,q,"Rất vui vì bạn đã ghé thăm Batdongsan.com.vn. Hiện CSKH đang không online, vui lòng để lại lời nhắn cho chúng tôi!")}return true}}}return false};this.likeAndDislike=function(r,q){b.server.likeOrDislikeSupporter(r,q)};this.addChatContainer=function(){var q=$(document.createElement("div"));q.addClass("chat-container");$("body").append($(document.createElement("div")).addClass("emoticons"));q.append($("<div style ='display:none' id='chatSound'></div>"));$("body").append(q);q.append($(strChatContainerTemplate).tmpl())};this.loadChatHistoryMessage=function(q,r,u){var s=$("#chatRoom-"+q.chatRoomId);var t=$("#messages-"+q.chatRoomId);var w=t.find("#m-0");var v;if(senderId==q.senderId){if(w.length!=0){v=$(strNewMessageTemplateRight).tmpl(q);w.after(v)}else{v=$(strNewMessageTemplateRight).tmpl(q).prependTo(t)}}else{if(w.length!=0){v=$(strNewMessageTemplateLeft).tmpl(q);w.after(v)}else{v=$(strNewMessageTemplateLeft).tmpl(q).prependTo(t)}BDSChatInbox.getAvatar(q,r,v)}BDSChatInbox.processDatetimeHistory(w,q,t,u);if(typeof(v)!="undefined"){v.emoticons(i)}};this.requestHistory=function(t){try{var r=$("#chatRoom-"+t+" .message");var s=0;if(r.length>0){if($(r[0]).attr("id")!="m-0"){s=parseInt($(r[0]).attr("timestamp"))}else{if(r.length>1){s=parseInt($(r[1]).attr("timestamp"))}}}b.server.requestHistory(t,s)}catch(q){}};this.processDatetimeHistory=function(v,q,r,t){var u=new Date(q.timestamp);var s=new Date(t);var w=p.Year;if(m[q.chatRoomId].lastTime==null){m[q.chatRoomId].lastTime=u}if(u.getFullYear()<s.getFullYear()){w=p.Year}else{if(u.getMonth()<s.getMonth()){w=p.Month}else{if(u.getDate()<s.getDate()){w=p.Day}else{w=p.Hour}}}this.removeTimeMessageHistory(w,r,u,q.chatRoomId);this.addTimeMessage(u,w,r,false,v)};this.removeTimeMessageHistory=function(y,q,w,v){var x=q.find(".chat-time");if(x.length>0){var z=w.getFullYear();var u=w.getMonth();var s=w.getDate();var t=0;var r=null;switch(y){case p.Year:for(t=0;t<x.length;t++){r=new Date(new Date(parseInt($(x[t]).attr("timestamp"))));if(r.getFullYear()==z){$(x[t]).remove();if(r==m[v].lastTime){m[v].lastTime=w}}}break;case p.Month:for(t=0;t<x.length;t++){r=new Date(new Date(parseInt($(x[t]).attr("timestamp"))));if(r.getFullYear()==z&&r.getMonth()==u){$(x[t]).remove();if(r==m[v].lastTime){m[v].lastTime=w}}}break;case p.Day:for(t=0;t<x.length;t++){r=new Date(new Date(parseInt($(x[t]).attr("timestamp"))));if(r.getFullYear()==z&&r.getMonth()==u&&r.getDate()==s){$(x[t]).remove();if(r==m[v].lastTime){m[v].lastTime=w}}}break;case p.Hour:for(t=0;t<x.length;t++){r=new Date(new Date(parseInt($(x[t]).attr("timestamp"))));if(w.getTime()-r.getTime()<l*60*1000){$(x[t]).remove();if(r==m[v].lastTime){m[v].lastTime=w}}}break;default:break}}};this.loadStaff=function(){b.server.requestSupporter().fail(function(q){})};this.closeAllRoom=function(){for(key in m){if(m[key].toUserId!=undefined){BDSChatInbox.endChat(key)}}};this.playSound=function(){};this.requestInboxRooms=function(){b.server.requestInboxRooms()};this.initInbox=function(r){var v=0;var w=0;var x=true;for(var u=0;u<r.length;u++){var t;if(r[u].ProductId==0){t=$(strChatUserInboxPgroup1Template).tmpl()}else{t=$(strChatUserInboxPgroupTemplate).tmpl({ProductId:r[u].ProductId});$.ajax({url:j+"?action=getproduct&productId="+r[u].ProductId,success:function(D){if(D.success){var C=$(strChatUserInboxPgroupProductTemplate).tmpl(D.product);$("#chat-product-group-"+D.product.ProductId).prepend(C);var B=C.find("img");B.error(function(){B.attr("src",g)})}}})}t.appendTo($(".chat-user-mgr-inbox-content").children());for(var y=0;y<r[u].Rooms.length;y++){v++;x=false;if(r[u].Rooms[y].ChatMessage!=null){if(r[u].Rooms[y].ChatMessage.senderId!=senderId&&r[u].Rooms[y].ChatMessage.isRead!=undefined&&!r[u].Rooms[y].ChatMessage.isRead){w++;x=true}var s=$(strChatUserInboxRinfoTemplate).tmpl({Name:BDSChatInbox.subString(r[u].Rooms[y].Room.ClientFromUserId==senderId?r[u].Rooms[y].Room.ToFullName:r[u].Rooms[y].Room.FromFullName,25),Message:BDSChatInbox.subString(r[u].Rooms[y].ChatMessage.messageText,30),Time:BDSChatInbox.convertTime(r[u].Rooms[y].ChatMessage.timestamp,(new Date()).getTime()),ClassInbox:r[u].Rooms[y].ChatMessage.senderId==senderId?"outbox":"",RoomId:r[u].Rooms[y].Room.ChatRoomId,ProductId:r[u].Rooms[y].Room.ProductId,UserId:r[u].Rooms[y].Room.ClientFromUserId==senderId?r[u].Rooms[y].Room.ClientToUserId:r[u].Rooms[y].Room.ClientFromUserId,OnlineClass:r[u].Rooms[y].IsOnline?"online-status":"",UnreadClass:x?"unread":"",Email:r[u].Rooms[y].User!=null?r[u].Rooms[y].User.Email:"",PhoneNumber:r[u].Rooms[y].User!=null?r[u].Rooms[y].User.PhoneNumber:"",TotalUnread:r[u].Rooms[y].TotalUnread});s.appendTo(t.find("ul"));s.click(function(){var C=$(this).attr("roomId");if($("#chatPopup-"+C).length==0){var D=$(this).attr("userId");var B=$(this).attr("productId");e=parseInt($(this).attr("roomId"));BDSChatInbox.initiateChat(D,B)}});s.emoticons(i);s.find(".chat-inbox-more-info").click(function(B){BDSChatInbox.displayMoreUserInfo($(this));B.stopPropagation();return false})}}}$(document).click(function(){if($(".chat-inbox-more-info-content").length>0){$(".chat-inbox-more-info-content").remove()}});var q=$(".chat-inbox-room");if(q.length>0){$(".chat-inbox-count-all").addClass("bold");$(".chat-inbox-count-all").click(function(){if(n!=1){$(".chat-user-mgr-inbox-header ul li").removeClass("bold");$(this).addClass("bold");n=1;BDSChatInbox.filterChatRoom()}});$(".chat-inbox-count-read").click(function(){if(n!=2){$(".chat-user-mgr-inbox-header ul li").removeClass("bold");$(this).addClass("bold");n=2;BDSChatInbox.filterChatRoom()}});$(".chat-inbox-count-unread").click(function(){if(n!=3){$(".chat-user-mgr-inbox-header ul li").removeClass("bold");$(this).addClass("bold");n=3;BDSChatInbox.filterChatRoom()}});var A=$(q[0]).attr("userId");var z=$(q[0]).attr("productId");e=parseInt($(q[0]).attr("roomId"));BDSChatInbox.initiateChat(A,z)}$(".chat-inbox-count-all span").text("("+v+")");$(".chat-inbox-count-unread span").text("("+w+")");$(".chat-inbox-count-read span").text("("+(v-w)+")")};this.displayMoreUserInfo=function(q){var v=$(q).attr("RoomId");if($(".chat-inbox-more-info-content").length>0){var r=$(".chat-inbox-more-info-content").attr("RoomId");$(".chat-inbox-more-info-content").remove();if(r==v){return}}var s=$(q).attr("email");var u=$(q).attr("phonenumber");var t=$(strChatInboxItemInfoTemplate).tmpl({Email:s,PhoneNumber:u,RoomId:v});$(q).find(".chat-inbox-more-info-icon").append(t);t.click(function(w){w.stopPropagation();return false})};this.addChatArea=function(r,u,t,q){this.removeRoom();var s=$(strChatInboxPopupTemplate).tmpl({id:r,fullName:t}).appendTo($(".chat-user-mgr-chat-area"));$(strChatInboxPopupHeaderTemplate).tmpl().appendTo(s);q.appendTo(s);s.find(".chatPopup-header .header-title").append(u);s.find(".chatPopup-header").css({"background-color":"#ededed","border-bottom":"1px solid #999999",color:"#000","border-radius":0,"-webkit-border-radius":0,"-moz-border-radius":0,});s.find(".user-status").removeAttr("style");s.find(".link-chat-bds-header").css({display:"none",});s.find(".chat-header-bds").css({"background-color":"#ededed","margin-left":0});s.find(".chat-command").css({height:"58px"});s.find(".div-emoticon").css({top:"7px"});s.find(".chatNewMessage").css({width:"375px","min-height":"54px"});s.find(".room-product-info-title").css({overflow:"inherit",});$(".chat-hiddendiv").css({width:"375px","min-height":"54px"})};this.removeRoom=function(){var q=$(".chat-user-mgr .chat-user-mgr-chat-area").children();if(q.length>0){BDSChatInbox.closeRoom(q.attr("roomid"));q.remove()}};this.updateStatus=function(t,r){var q=$(".chat-user-mgr .chat-inbox-room");if(q.length>0){for(var s=0;s<q.length;s++){if($(q[s]).attr("userid")==t.UserId){if(r){$(q[s]).find(".chat-inbox-room-info").addClass("online-status")}else{$(q[s]).find(".chat-inbox-room-info").removeClass("online-status")}}}}};this.updateLastestMessage=function(r,s,x){var w=$("#chat-inbox-room-"+s.chatRoomId);var y=false;if(r.senderId!=senderId&&r.isRead!=undefined&&!r.isRead){y=true}if(w.length>0){var z=w.find(".chat-inbox-room-last-msg");z.text(BDSChatInbox.subString(r.messageText,30));w.find(".chat-inbox-room-time span").text(BDSChatInbox.convertTime(r.timestamp,new Date().getTime()));if(senderId==r.senderId){z.addClass("outbox")}else{z.removeClass("outbox")}if(y){BDSChatInbox.addUnreadMessage(s.chatRoomId);var D=$("#chat-inbox-room-unread-"+s.chatRoomId);if(D.length>0){var t=parseInt(D.attr("totalunread"));t++;D.text("("+t+")");D.attr("totalunread",t)}}}else{var q=$("#chat-product-group-"+s.productId);if(q.length==0){q=$(strChatUserInboxPgroupTemplate).tmpl({ProductId:s.productId});$.ajax({url:j+"?action=getproduct&productId="+s.productId,success:function(G){if(G.success){var F=$(strChatUserInboxPgroupProductTemplate).tmpl(G.product);$("#chat-product-group-"+G.product.ProductId).prepend(F);var E=F.find("img");E.error(function(){E.attr("src",g)})}}});q.appendTo($(".chat-user-mgr-inbox-content").children())}var A=BDSChatInbox.getOrtherUser(s.chatUsers);var u=$(strChatUserInboxRinfoTemplate).tmpl({Name:BDSChatInbox.subString(A.FullName,25),Message:BDSChatInbox.subString(r.messageText,30),Time:BDSChatInbox.convertTime(r.timestamp,(new Date()).getTime()),ClassInbox:senderId==r.senderId?"outbox":"",RoomId:s.chatRoomId,ProductId:s.productId,UserId:A.UserId,OnlineClass:x?"online-status":"",UnreadClass:y?"unread":"",Email:"",PhoneNumber:"",TotalUnread:1});u.appendTo(q.find("ul"));u.click(function(){var F=$(this).attr("roomId");if($("#chatPopup-"+F).length==0){var G=$(this).attr("userId");var E=$(this).attr("productId");e=parseInt($(this).attr("roomId"));BDSChatInbox.initiateChat(G,E)}});u.emoticons(i);u.find(".chat-inbox-more-info").click(function(E){BDSChatInbox.displayMoreUserInfo($(this));E.stopPropagation();return false});var v=$(".chat-inbox-count-all span");v.text("("+(parseInt(v.text().substring(1,v.text().length-1))+1)+")");if(y){var C=$(".chat-inbox-count-unread span");C.text("("+(parseInt(C.text().substring(1,C.text().length-1))+1)+")")}else{var B=$(".chat-inbox-count-read span");B.text("("+(parseInt(B.text().substring(1,B.text().length-1))+1)+")")}}};this.addUnreadMessage=function(r){var t=$("#chat-inbox-room-"+r);if(!t.hasClass("unread")){t.addClass("unread");var q=$(".chat-inbox-count-read span");q.text("("+(parseInt(q.text().substring(1,q.text().length-1))-1)+")");var s=$(".chat-inbox-count-unread span");s.text("("+(parseInt(s.text().substring(1,s.text().length-1))+1)+")");if(n==2||n==3){BDSChatInbox.filterChatRoom()}}};this.convertTime=function(A,s){var t=new Date(A);var r=new Date(s);var B=t.getFullYear();var y=t.getMonth()+1;var u=t.getDate()<10?("0"+t.getDate()):t.getDate();var w=t.getHours();var v=w%12==0&&w>0&&w!=24?12:w%12;var x=t.getMinutes()<10?("0"+t.getMinutes()):t.getMinutes();var z=t.getSeconds()<10?("0"+t.getSeconds()):t.getSeconds();var q=w>12?" PM":" AM";if(t.getFullYear()<r.getFullYear()){return v+":"+x+q+" "+u+" tháng "+y+" năm "+B}else{if(t.getMonth()<r.getMonth()){return v+":"+x+q+" "+u+" tháng "+y}else{if(t.getDate()<r.getDate()){return v+":"+x+q+" "+u+" tháng "+y}else{return v+":"+x+q}}}};this.getOrtherUser=function(r){for(var q=0;q<r.length;q++){if(r[q].UserId!=senderId){return r[q]}}return null};this.reportSpam=function(){var q=this.getCurrentRoomId();if(q.length>0){b.server.reportSpam(q);alert("Phản hồi của bạn đã được gửi đến ban quản trị.")}};this.enableChatSound=function(q){k=!k;if(k){$(q).text("Tắt âm thanh")}else{$(q).text("Bật âm thanh")}};this.deleteMessage=function(){var q=this.getCurrentRoomId();if(q.length>0){if(confirm("Bạn có chắc muốn tất cả tin nhắn")){b.server.deleteMessage(q)}}};this.blockMessage=function(){var q=this.getCurrentRoomId();if(q.length>0){b.server.blockMessage(m[q].toUserId);alert("Bạn đã chặn tin nhắn của người dùng này")}};this.filterChatRoom=function(){var w=$("#txtFiterChatInbox").val().trim();var q=$(".chat-product-group");if(q.length>0){var r;var s;for(var t=0;t<q.length;t++){r=$(q[t]).find(".chat-inbox-room");s=0;if(r.length>0){for(var v=0;v<r.length;v++){var u=n==1||(n==2&&!$(r[v]).hasClass("unread"))||(n==3&&$(r[v]).hasClass("unread"));if(!u||$(r[v]).find(".chat-inbox-room-email").text().toLowerCase().indexOf(w)==-1){$(r[v]).hide()}else{$(r[v]).show();s++}}if(s==0){$(q[t]).hide()}else{$(q[t]).show()}}}}};this.getCurrentRoomId=function(){var q=$(".chat-user-mgr .chat-user-mgr-chat-area").children();if(q.length>0){return q.attr("roomid")}return""}};