var urlMarkerHover="https://file4.batdongsan.com.vn/images/Maps/map-yellow.png";var urlMarkerNormal="https://file4.batdongsan.com.vn/images/Maps/map-blue.png";(function(a){a.fn.MapControler=function(i){var j=function(){var p="tt";var x=3;var r=3;var s=300;var u=10;var w=20;var n=95;var k=0;var y,v,m,l,o;var q=document.all?true:false;return{show:function(t,z){if(y==null){y=document.createElement("div");y.setAttribute("id",p);v=document.createElement("div");v.setAttribute("id",p+"top");m=document.createElement("div");m.setAttribute("id",p+"cont");l=document.createElement("div");l.setAttribute("id",p+"bot");y.appendChild(v);y.appendChild(m);y.appendChild(l);document.body.appendChild(y);y.style.opacity=0;y.style.filter="alpha(opacity=0)";document.onmousemove=this.pos}y.style.display="block";m.innerHTML=t;y.style.width=z?z+"px":"auto";if(!z&&q){v.style.display="none";l.style.display="none";y.style.width=y.offsetWidth;v.style.display="block";l.style.display="block"}if(y.offsetWidth>s){y.style.width=s+"px"}o=parseInt(y.offsetHeight)+x;clearInterval(y.timer);y.timer=setInterval(function(){j.fade(1)},w)},pos:function(t){var A=q?event.clientY+document.documentElement.scrollTop:t.pageY;var z=q?event.clientX+document.documentElement.scrollLeft:t.pageX;y.style.top=(A-o)+"px";y.style.left=(z+r)+"px"},fade:function(z){var t=k;if((t!=n&&z==1)||(t!=0&&z==-1)){var A=u;if(n-t<u&&z==1){A=n-t}else{if(k<u&&z==-1){A=t}}k=t+(A*z);y.style.opacity=k*0.01;y.style.filter="alpha(opacity="+k+")"}else{clearInterval(y.timer);if(z==-1){y.style.display="none"}}},hide:function(){clearInterval(y.timer);y.timer=setInterval(function(){j.fade(-1)},w)}}}();var b=this;this.map=null;this.markers=[];this.markersProject=[];this.markerUtilities=[];this.polyline=null;this.boundary=[];this.currentPjID=null;this.circle=null;this.tooltip=null;this.btnUpdateMapIdleResult=a(".btn-map-update-result");this.data=[];this.dataProject=[];this.IsShowDetail=false;this.isDrawing=false;this.lstPoint="";this.isMapIdle=false;this.isShowUtil=false;this.isMapIdle=false;this.isShowRefreshButton=false;this.isMapChangeByCode=false;this.isZoomRegion=false;this.regionVisible=false;this.initialize=function(){var o;if(i.zoom!=""){o=parseInt(i.zoom)}else{o=14}var k;var m;if(i.center!=""){var l=i.center.split(":");k=parseFloat(l[0]);m=parseFloat(l[1])}else{k=16.094806;m=107.628537}var n={center:new google.maps.LatLng(k,m),zoom:o,overviewMapControl:true,overviewMapControlOptions:{opened:false},panControl:false,rotateControl:false,scaleControl:false,zoomControl:false,streetViewControl:false,mapTypeControl:false,scrollwheel:true,mapTypeId:google.maps.MapTypeId.ROADMAP,draggable:true};this.map=new google.maps.Map(b[0],n);this.tooltip=new Tooltip({map:this.map});this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(document.getElementById("controlArea"));b.btnUpdateMapIdleResult.bind("click",function(){traceEventMap();b.clearPoint();b.callBackClearPointEvent();if(b.polyline!=undefined){b.polyline.setMap(undefined)}b.btnUpdateMapIdleResult.hide();var p=b.map.getBounds();var q=p.getNorthEast();var r=p.getSouthWest();b.callbackMapChange(r.lat(),r.lng(),q.lat(),q.lng(),{zoom:b.getZoom(),center:b.getCenter()})});google.maps.event.addListener(this.map,"idle",function(){if(this.getZoom()<minZoomAllowSearch){return}if(b.isZoomRegion){b.isZoomRegion=false;return}if(this.getZoom()>=minZoomAllowSearch&&!b.isDrawing&&b.isShowRefreshButton){b.btnUpdateMapIdleResult.show("highlight",1000)}else{b.btnUpdateMapIdleResult.hide();b.isShowRefreshButton=true;b.isMapIdle=false}});google.maps.event.addListener(this.map,"zoom_changed",function(){var p=b.getZoom();if(b.regionVisible&&p<=minZoomAllowSearch){return}b.lastZoom=p;if(p<minZoomAllowSearch){b.isZoomRegion=true;b.btnUpdateMapIdleResult.hide();b.isShowRefreshButton=true;b.isMapIdle=false;b.IsShowDetail=false}else{c()}})};this.ShowBoundary=function(p){for(var l=0;l<p.length;l++){var n=p[l];var o=[];var q;for(var m=0;m<n.length;m+=2){if(m+1==n.length){break}o.push(new google.maps.LatLng(n[m+1],n[m]))}var r={path:o,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:3};q=new google.maps.Polyline(r);q.setMap(this.map);this.boundary.push(q)}};this.ClearBoundary=function(){if(this.boundary.length==0){return}for(var k=0;k<this.boundary.length;k++){this.boundary[k].setMap(null)}this.boundary=[]};this.clearPoint=function(){if(b.markers!=undefined){for(var k=0;k<b.markers.length;k++){b.markers[k].setMap(null)}b.markers=[]}if(b.markersProject!=undefined){for(var k=0;k<b.markersProject.length;k++){b.markersProject[k].setMap(null)}b.markersProject=[]}if(this.markerCluster!=null){this.markerCluster.clearMarkers()}};this.resizeMap=function(k){if(typeof(k)=="undefined"||!k){this.isMapChangeByCode=true}google.maps.event.trigger(this.map,"resize")};this.setContext=function(l,o,k){if(l!=undefined&&l!=""){}if(o!=undefined&&k!=undefined){var m=parseFloat(k.split(":")[0]);var n=parseFloat(k.split(":")[1]);b.isMapChangeByCode=true;this.map.setCenter(new google.maps.LatLng(m,n));this.map.setZoom(parseInt(o))}};this.getZoom=function(){return this.map.getZoom()};this.getCenter=function(){return this.map.getCenter().lat()+":"+this.map.getCenter().lng()};this.beginDrawButton=a(".begindraw");this.deleteShapeButton=a(".delshape");this.beginDrawButton.bind("click",this,function(n){var o=n||window.event;if(o.data.map.getZoom()<minZoomAllowSearch){alert("Bạn cần phóng to bản đồ hơn nữa vào khu vực bạn cần vẽ");return}b.isDrawing=true;o.data.beginDrawButton.hide();o.data.deleteShapeButton.show();o.data.callBackClearPointEvent();if(o.data.polyline!=undefined){o.data.polyline.setMap(undefined)}o.data.mapPoly=new google.maps.Polyline({strokeColor:"#585858",strokeOpacity:1,map:o.data.map});o.data.map.setOptions({draggableCursor:"crosshair",draggable:false});var p=10;var m=0;function k(q){return function(){q.listLatlgn=new Array();function r(t){q.mapPoly.getPath().push(t.latLng);var s=new Date().valueOf();if(s-m>=p){m=s;q.listLatlgn.push(t.latLng)}}google.maps.event.addListener(o.data.map,"mousemove",function(s){r(s)})}}if(f()){a("body").bind("touchmove",function(q){q.preventDefault();q.stopPropagation()})}google.maps.event.addListener(o.data.map,"mousedown",k(o.data));function l(q){return function(){if(f()){a("body").unbind("touchend")}else{a("body").unbind("mouseup")}if(q.mapPoly!=undefined){if(f()){a("body").unbind("touchmove")}q.map.setOptions({draggableCursor:"openhand",draggable:true});google.maps.event.clearListeners(q.map,"mousedown");google.maps.event.clearListeners(q.map,"mousemove");q.mapPoly.setMap(undefined);q.endDraw()}}}if(f()){a("body").bind("touchend",this,l(o.data))}else{a("body").bind("mouseup",this,l(o.data))}});this.deleteShapeButton.bind("click",this,function(k){k.data.DeleteShape()});this.DeleteShape=function(){this.beginDrawButton.show();this.deleteShapeButton.hide();if(this.polyline!=undefined){this.polyline.setMap(undefined);this.polyline=null}b.isDrawing=false;this.callBackClearPointEvent(true)};this.endDraw=function(k){if(b.listLatlgn!=null){this.beginDrawButton.hide();this.deleteShapeButton.show();var n=new Array();if(k==undefined){var l=5;var o;o=Math.round(b.listLatlgn.length/50);if(b.listLatlgn.length<30){l=1;o=2}for(var m=0;m<b.listLatlgn.length;m++){if(m%(l*o)==0){n.push(b.listLatlgn[m])}}}else{n=b.listLatlgn}b.polyline=new google.maps.Polygon({path:n,strokeColor:"#585858",strokeWeight:3,editable:true,fillColor:"#ccc",fillOpacity:0.5});b.polyline.setMap(b.map);b.findPoint(b.polyline,k);google.maps.event.addListener(b.polyline.getPath(),"set_at",function(){b.findPoint(b.polyline)});google.maps.event.addListener(b.polyline.getPath(),"insert_at",function(){b.findPoint(b.polyline)})}b.listLatlgn=null};this.findPoint=function(r,l){var k=d(r);var p=k.getNorthEast();var s=k.getSouthWest();if(typeof(l)=="undefined"){l={mapStatus:mapStatusEnum.Map}}else{l.mapStatus=mapStatusEnum.Map}this.lstPoint="";var q=r.getPath().getArray();for(var m=0;m<q.length;m++){var n=q[m].lat();var o=q[m].lng();if(this.lstPoint.length>0){this.lstPoint+=","}this.lstPoint+=n+":"+o}this.callbackMapChange(s.lat(),s.lng(),p.lat(),p.lng(),l)};function d(q){var k=new google.maps.LatLngBounds();var o=q.getPaths();var n;for(var m=0;m<o.getLength();m++){n=o.getAt(m);for(var l=0;l<n.getLength();l++){k.extend(n.getAt(l))}}return k}this.fullScreenButton=a(".fullscreen");this.exitFullScreenButton=a(".exitfullscreen");this.fullScreenButton.bind("click",this,function(k){a("body").css("overflow","hidden");a(".dropdown-navigative-menu").css("z-index",0);a(".map-view").addClass("map-view-fullscreen");a(".main-view").css("position","fixed");a(".main-view").css("height",a(document).height());a(".main-view").addClass("main-view-fullscreen");k.data.exitFullScreenButton.show();k.data.fullScreenButton.hide();k.data.resizeMap()});this.exitFullScreenButton.bind("click",this,function(k){a(".map-view").removeClass("map-view-fullscreen");a(".main-view").css("position","relative");a(".main-view").css("height","385px");a(".main-view").removeClass("main-view-fullscreen");k.data.exitFullScreenButton.hide();k.data.fullScreenButton.show();a(".item-view").css("height","360px");k.data.resizeMap();a("body").css("overflow","auto");a(".dropdown-navigative-menu").css("z-index",1000)});a(".map-zoom-in").bind("click",b,function(k){var l=k.data.map.getZoom();k.data.map.setZoom(l+1)});a(".map-zoom-out").bind("click",b,function(k){var l=k.data.map.getZoom();k.data.map.setZoom(l-1)});this.isInPolyline=function(m,k,l){if(m!=null){return google.maps.geometry.poly.containsLocation(new google.maps.LatLng(k,l),m)}return true};this.getCornerBounds=function(){var k=b.map.getBounds();if(k==undefined){return null}var m=k.getNorthEast();var n=k.getSouthWest();var l={minLat:n.lat(),minLong:n.lng(),maxLat:m.lat(),maxLong:m.lng()};return l};this.getBoundOfPolygon=function(q){var l=q.split(",");if(l<2){return{}}var r=0,t=100000,s=0,u=100000;for(var n=0;n<l.length;n++){var k=l[n].split(":");var o=parseFloat(k[0]);var p=parseFloat(k[1]);if(r<o){r=o}if(t>o){t=o}if(u>p){u=p}if(s<p){s=p}}var m={minLat:t,minLong:u,maxLat:r,maxLong:s};return m};function f(){return device.ipad()||device.tablet()||device.ipod()||device.iphone()||device.androidTablet()||device.blackberryTablet()||device.android()}this.showMapProject=function(k){this.dataProject=[];for(var l=0;l<k.length;l++){if(this.isInPolyline(this.polyline,k[l].lat,k[l].lon)){this.dataProject.push(k[l])}}this.showPointProject(this.dataProject);return this.dataProject};this.showPointProject=function(k){this.clearPoint();if(k.length==0){return}var l=new google.maps.LatLngBounds();for(var n=0;n<k.length;n++){var o=k[n];var q=this._getProjectTooltipContentString(o);var p=new google.maps.LatLng(o.lat,o.lon);b.markersProject.push(new google.maps.Marker({position:p,map:this.map,tooltip:q,icon:{url:o.id!=this.currentPjID?urlMarkerNormal:urlMarkerHover,size:o.id!=this.currentPjID?new google.maps.Size(34,47):new google.maps.Size(32,46)},zIndex:o.id!=this.currentPjID?0:1}));b.markersProject[b.markersProject.length-1].id=o.id;l.extend(p)}if(this.polyline==null){this.map.fitBounds(l)}for(var m=0;m<b.markersProject.length;m++){b.markersProject[m].addListener("click",function(){if(b.dataProject!=null&&b.dataProject!=undefined&&b.dataProject.length>0){for(var r=0;r<b.dataProject.length;r++){if(b.dataProject[r].id==this.id){b.ShowProject(b.dataProject[r]);break}}}});b.markersProject[m].addListener("mouseover",function(){if(this.id!=b.currentPjID){this.setIcon({url:urlMarkerHover,size:new google.maps.Size(30,41)});b.tooltip.addTip(this);b.tooltip.getPos2(this.getPosition())}});b.markersProject[m].addListener("mouseout",function(){if(this.id!=b.currentPjID){this.setIcon({url:urlMarkerNormal,size:new google.maps.Size(30,43)})}b.tooltip.removeTip()})}};this.showProjectById=function(m,k){var l=this.findProjectDataInfo(m);if(l!=null){this.ShowProject(l,k);this.map.setZoom(18)}};this.ShowProject=function(p,k){this.IsShowDetail=true;if(p.id!=this.currentPjID&&this.currentPjID!=null){var m=this.findProjectMarker(this.currentPjID);if(m!=null){m.setIcon({url:urlMarkerNormal,size:new google.maps.Size(30,41)});m.setZIndex()}}var o=this.findProjectMarker(p.id);if(o==null){var l=null;var q=this._getProjectTooltipContentString(p);this.markersProject.push(new google.maps.Marker({position:new google.maps.LatLng(p.lat,p.lon),map:this.map,tooltip:q,icon:{url:urlMarkerNormal,size:new google.maps.Size(30,43)}}));var n=this.markersProject.length-1;o=this.markersProject[n];o.id=p.id;o.addListener("click",function(){for(var r=0;r<b.markersProject.length;r++){if(b.markersProject[r].id==this.id){b.ShowProject(b.dataProject[r]);break}}});o.addListener("mouseover",function(){if(this.id!=b.currentPjID){b.tooltip.addTip(this);b.tooltip.getPos2(this.getPosition())}});o.addListener("mouseout",function(){b.tooltip.removeTip()})}if(o.map==null){o.setMap(this.map)}o.setIcon({url:urlMarkerHover,size:new google.maps.Size(30,41)});o.setZIndex(300);o.setMap(this.map);this.currentPjID=o.id;this.callbackShowProjectDetailInfoWindow(p);if(k){this.map.setCenter(new google.maps.LatLng(p.lat,p.lon))}};this.findProjectDataInfo=function(l){if(this.dataProject!=undefined&&this.dataProject.length>0){for(var k=0;k<this.dataProject.length;k++){if(this.dataProject[k].id==l){return this.dataProject[k]}}}};this._getProjectTooltipContentString=function(l){var k='<div class="infowindow-product-preview">';k+='<div class="infowindow-product-preview-detail">';k+='<span class="infowindow-product-preview-title">'+l.title+"</span><br/>";k+='<div class="infowindow-product-preview-avatar">';k+='<img src="'+l.avatar+'"/>';k+="</div>";k+="<strong>Địa chỉ: </strong>"+l.address;k+="</div>";k+="</div>";return k};this.findProjectMarker=function(l){if(this.markersProject!=undefined){for(var k=0;k<this.markersProject.length;k++){if(this.markersProject[k].id==l){return this.markersProject[k]}}}return null};this.callbackMapChange=function(){};this.callBackSearchPlace=function(){};this.callBackClearPointEvent=function(){};this.callbackShowProjectDetailInfoWindow=function(){};var g=[];this.ShowRegionBoundary=function(p){c();if(p==null||p==""){return}var u=[];var v;var l=function(y,z,k){google.maps.event.addListener(y,"mousemove",function(A){this.setOptions({fillOpacity:0.2});this.setOptions({fillColor:"#00FF00"});j.show("<b>Khu vực : </b>"+z+" <br/><p><b>Số lượng tin rao :</b> "+k+"</p>")})};var m=function(k){google.maps.event.addListener(k,"mouseout",function(y){this.setOptions({fillColor:"#D0E1AB"});this.setOptions({fillOpacity:0.3});j.hide()})};b.regionVisible=true;var n=function(z,A,k,y){google.maps.event.addListener(A,"click",function(B){j.hide();c();var C=14;b.isMapChangeByCode=true;b.isZoomRegion=true;z.fitBounds(A.getBounds());z.setZoom(C)})};for(var q=0;q<p.length;q++){var s=p[q][0];var x=p[q][1];var t=[];for(var r=0;r<s.length;r+=2){if(r+1==s.length){break}t.push(new google.maps.LatLng(s[r+1],s[r]))}var o=e();var w={path:t,strokeColor:"#A8684A",strokeOpacity:1,strokeWeight:1.5,fillColor:"#D0E1AB",indexID:q,fillOpacity:0.2};v=new google.maps.Polygon(w);v.setMap(this.map);l(v,x[0].Region,x[0].count);m(v);n(this.map,v,x[0].Region,x[0].Id);g.push(v)}};if(!google.maps.Polygon.prototype.getBounds){google.maps.Polygon.prototype.getBounds=function(){var k=new google.maps.LatLngBounds();this.getPath().forEach(function(l,m){k.extend(l)});return k}}function h(l,k,m){if(l instanceof google.maps.LatLng){k.call(m,l)}else{if(l instanceof google.maps.Data.Point){k.call(m,l.get())}else{l.getArray().forEach(function(n){h(n,k,m)})}}}function e(){var m="0123456789ABCDEF".split("");var k="#";for(var l=0;l<6;l++){k+=m[Math.floor(Math.random()*16)]}return k}function c(){if(g!=null&&g!=undefined){for(var k=0;k<g.length;k++){g[k].setMap(null)}g=[];b.regionVisible=false}}return b}}(jQuery));