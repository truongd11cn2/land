var GuestUploadNonFlash;var dropText1=bds_lang.UploadImageControl.DropText1;var dropText2=bds_lang.UploadImageControl.DropText2;var maxcount=0;var uploadTemp=null;GuestUploadNonFlash=function(e){this.strTemplate='<div class="droptext textUploadNotice">'+dropText1+"</div>";this.strTemplate+='<div class="thumbnails"></div>';this.strTemplate+='<div style="float: left;margin-right: 5px;border-radius: 5px;width: 164px;height: 230px;background-image: url(/Plugin/BDSUpload/images/bg-upload-area.png);background-color: rgb(218, 228, 237); position: relative; overflow: hidden; direction: ltr; background-position: 50% 95%;background-repeat: no-repeat no-repeat; margin-bottom: 10px; display:none;" class="divFileProgressContainer">';this.strTemplate+='<div class="progressWrapper" id="divFileProgress"></div></div>';this.strTemplate+='<div class="spanButtonPlaceholder block-upload-item" id="upload-drop-zone">';this.strTemplate+="<p>"+bds_lang.UploadImageControl.DragMessage+"</p>";this.strTemplate+="</div>";this.strTemplate+='<div class="divFileProgressContainer1"></div>';this.strTemplate+='<div class="droptext">';this.strTemplate+="{dropProcessingText}";this.strTemplate+="</div>";var g='<div class="progressContainer">';g+='<a class="progressCancel" href="#" style="visibility: hidden;"> </a>';g+='<div class="upload-tool-delete" style="display:none;"></div>';g+='<center><img src="upload-loading.gif"/*tpa=https://batdongsan.com.vn/Plugin/BDSUpload/images/upload-loading.gif*/ /></center>';g+='<div class="progressSpinner"></div>';g+='<span class="imgthumb" style="display:none;"></span>';g+='&nbsp;&nbsp;<span style="display:none;" class="progressSize"></span>';g+='<div class="progressBarStatus">'+bds_lang.UploadImageControl.Completed+"</div>";g+='<div class="progressBarStatus1">'+bds_lang.UploadImageControl.Uploading+"</div>";g+='<div class="progressBarInProgress" style="width: 110%;"></div>';g+="</div>";var d=$("#"+e);var d=$("#"+e);var c=d.attr("input");var f=d.attr("is360")=="true";this.strList=g;this.strListView='<div class="imgContainer">';this.strListView+='<div class="imgthumb"><div class="upload-image-tools"><span class="upload-tool-rotation"></span><span class="upload-tool-delete"></span></div></div>';if(f){this.strListView+='<label class="imgthumbcheck360" onclick="GuestUploadNonFlash.toggleImage360Check(this, \''+c+"')\"><span></span> Ảnh 360</label>";this.strListView+='<div class="imgthumbtitle"><textarea disabled="disabled" maxlength="100" placeholder="nhập chú thích cho ảnh" cols="50" rows="2" onchange="GuestUploadNonFlash.updateFinalValue(\''+c+"')\"></textarea></div>"}this.strListView+="</div>";var h=d.attr("svid");var j="https://upload2.batdongsan.com.vn/";var i=d.attr("key");maxcount=parseInt(d.attr("maxcount"))-($("#"+c).val().length>0?$("#"+c).val().split("||").length:0);this.uploader=new qq.FineUploader({svId:h,svurl:j,element:$("#"+e)[0],listElement:null,multiple:true,request:{endpoint:j+"Upload.php",inputName:"fileToUpload",params:{project:"bds",UploadType:"upload",StringDecypt:i,submit:1}},validation:{sizeLimit:20480000,minSizeLimit:1024,itemLimit:parseInt(d.attr("maxcount")),maxCount:parseInt(d.attr("maxcount")),trueCount:maxcount,allowedExtensions:["jpeg","jpg","gif","png"]},messages:{typeError:"{file} không hợp lệ. Các loại file hợp lệ là: {extensions}.",sizeError:"{file} là quá to, kích thước file lớn nhất là 2Mb.",minSizeError:"{file} quá nhỏ, kích thước file nhỏ nhất là 100Kb.",emptyError:"{file} file trống rỗng, bạn hãy chọn lại các file mà không có nó.",noFilesError:"Không có file để tải lên.",tooManyItemsError:"Quá nhiều file ({netItems}) đã tải lên. Số lượng file có thể tải lên là {itemLimit}.",retryFailTooManyItems:"Thử lại thất bại - bạn đã chạm giới hạn số lượng file.",onLeave:"Các file đã được tải lên, nếu bạn dời đi việc tải lên sẽ bị hủy bỏ."},text:{uploadButton:bds_lang.UploadImageControl.SelectedFile+". (không quá 2MB)",dropProcessing:bds_lang.UploadImageControl.DropProcessing},template:this.strTemplate,fileTemplate:this.strList,fileTemplateView:this.strListView,deleteFile:{enabled:true,forceConfirm:true,endpoint:j+"GuestUploadNoFlash.aspx"},failedUploadTextDisplay:{mode:"custom"},cors:{expected:true,sendCredentials:true},classes:{deleteButton:"upload-tool-delete",statusText:"progressBarStatus1",cancel:"progressCancel",spinner:"progressSpinner",size:"progressSize",progressBar:"progressBarInProgress",file:"imgthumb",list:"progressWrapper",button:"spanButtonPlaceholder",dropProcessing:"droptext",drop:"divFileProgressContainer1",listView:"thumbnails"},callbacks:{onError:function(l,m,k,n){},onComplete:function(l,k,n){if($("#hddIsChanged").length>0){$("#hddIsChanged").val(1)}$(".divFileProgressContainer").hide();$(".divFileProgressContainer").html(g);if(n.success){$("div.imgthumb").each(function(){var o=$(this).attr("rel");$(this).find(".upload-tool-rotation").off("click").click(function(){GuestUploadNonFlash.rotateImage(o,e,$(this))})});var m=GuestUploadNonFlash.getFinalValue();if(m.split("||").length==1){$(".textUploadNotice").html(dropText2)}GuestUploadNonFlash.updateFinalValue(c);GuestUploadNonFlash.setAvatar()}},onDeleteComplete:function(k,n,m){if(!m){if($("#hddIsChanged").length>0){$("#hddIsChanged").val(1)}var l=GuestUploadNonFlash.getFinalValue();if(l==""){$(".textUploadNotice").html(dropText1)}GuestUploadNonFlash.updateFinalValue(c);GuestUploadNonFlash.setAvatar()}},onSubmit:function(k,l){},onUpload:function(k){$(".divFileProgressContainer").show()}}});if(parseInt(d.attr("maxcount"))==$("#"+c).val().split(",").length-1){$(".spanButtonPlaceholder").hide()}uploadTemp=this.uploader;$(".thumbnails").sortable({revert:true,placeholder:"block-upload-item",update:function(k,m){$("div.imgthumb").each(function(){var n=$(this).attr("rel");$(this).find(".upload-tool-rotation").off("click").click(function(){GuestUploadNonFlash.rotateImage(n,e,$(this))})});var l=GuestUploadNonFlash.getFinalValue();GuestUploadNonFlash.updateFinalValue(c);GuestUploadNonFlash.setAvatar()}});var a=navigator.userAgent.match(/MSIE (([0-9]+)(\.[0-9]+)?)/);if(a===null||parseInt(a[2])>9){$(".spanButtonPlaceholder").live("dragover",function(k){k.preventDefault&&k.preventDefault();$(this).addClass("drop-active");return false});$(".spanButtonPlaceholder").live("dragleave",function(k){k.preventDefault&&k.preventDefault();$(this).removeClass("drop-active");return false});var b=this.uploader;$(".spanButtonPlaceholder").live("drop",function(k){k.preventDefault&&k.preventDefault();$(this).removeClass("drop-active");var l=k.originalEvent.dataTransfer.files;b.addFiles(l);return false})}GuestUploadNonFlash.setAvatar();$("div.imgthumb").each(function(){var k=$(this).attr("rel");$(this).find(".upload-tool-rotation").off("click").click(function(){GuestUploadNonFlash.rotateImage(k,e,$(this))})})};GuestUploadNonFlash.toggleImage360Check=function(b,a){$(b).children("span").toggleClass("fa fa-check");if($(b).children("span").hasClass("fa")){$(b).next().children("textarea").removeAttr("disabled");$(b).prev().find(".upload-tool-rotation").hide()}else{$(b).next().children("textarea").attr("disabled","disabled");$(b).next().children("textarea").val("");$(b).prev().find(".upload-tool-rotation").show()}GuestUploadNonFlash.updateFinalValue(a)};GuestUploadNonFlash.getFinalValue=function(){var a="";$("div.imgthumb").each(function(){var c=$(this).attr("rel");if(a.length>0){a+="||"}a+=c;if($(this).next().children("span").hasClass("fa")){var b=$(this).next().next().children("textarea").val();var d=/##/ig;b=b.replace(d,"");var d=/\|\|/ig;b=b.replace(d,"");a+="##"+b}});return a};GuestUploadNonFlash.updateFinalValue=function(a){var b=GuestUploadNonFlash.getFinalValue();console.log(b);$("#"+a).val(b);$("#hddIsChanged").val(1)};GuestUploadNonFlash.removeImage=function(b,c,d,e,a){if(confirm(bds_lang.UploadImageControl.DeleteMessage)){uploadTemp._options.validation.trueCount=uploadTemp._options.validation.trueCount+1;$("#img"+c.replace(/[.]/g,"")).parent().remove();GuestUploadNonFlash.removeValue(c,e,a);$("#hddIsChanged").val(1)}};GuestUploadNonFlash.removeAdminImage=function(b,c,a){if(confirm(bds_lang.UploadImageControl.ConfirmDelete)){$("#img"+b.replace(/[.]/g,"")).remove();GuestUploadNonFlash.removeValue(b,c,a);$("#hddIsChanged").val(1)}};GuestUploadNonFlash.removeValue=function(d,c,b){var a=$("#"+c).val();if(a.length==0){return}else{GuestUploadNonFlash.updateFinalValue(c)}};GuestUploadNonFlash.rotateImage=function(e,i,m){e=$(m).parents(".imgthumb").attr("rel");if(e.indexOf("temp")<0){return}var h=$("#"+i);var q=h.attr("sv");var p=h.attr("svid");var g=h.attr("input");var o="";var l=e;var n=0;try{var d=e.split(".")[1];var c=e.split(".")[2];if(e.split(".").length>=4){n=parseInt(e.split(".")[3])}var r=d.split("-")[0];var s="";if(d.indexOf("_wm")>0){d=d.replace("_wm","")}var t=r.substring(0,4);var j=r.substring(4,6);var a=r.substring(6,8);o="https://file4.batdongsan.com.vn";if(n==0){o=o+"/rotate/90/temp/"+t+"/"+j+"/"+a+"/"+d+"."+c;l=p+"temp."+d+"."+c+".90"}else{if(n==90){o=o+"/rotate/180/temp/"+t+"/"+j+"/"+a+"/"+d+"."+c;l=p+"temp."+d+"."+c+".180"}else{if(n==180){o=o+"/rotate/270/temp/"+t+"/"+j+"/"+a+"/"+d+"."+c;l=p+"temp."+d+"."+c+".270"}else{if(n==270){o=o+"/resize/164x170/temp/"+t+"/"+j+"/"+a+"/"+d+"."+c;l=p+"temp."+d+"."+c}}}}}catch(b){console.log(b);$(m).parents(".imgContainer").removeClass("rotate-loading");return}var k=document.createElement("canvas");var f=new Image();f.setAttribute("crossOrigin","anonymous");f.src=o;f.onload=function(){k.id="myTempCanvas";k.width=Number(164>f.width?f.width:167);k.height=Number(170>f.height?f.height:170);if(k.getContext){var u=k.getContext("2d");u.drawImage(f,0,0,k.width,k.height);var v=k.toDataURL();if(v!=null&&v!=undefined){$(m).parents(".imgthumb").attr("style","background-image: url("+v+")")}else{$(m).parents(".imgthumb").attr("style","background-image: url("+o+")")}}else{$(m).parents(".imgthumb").attr("style","background-image: url("+o+")")}};$(m).parents(".imgthumb").attr("rel",l);GuestUploadNonFlash.updateFinalValue(g)};GuestUploadNonFlash.setAvatar=function(){$(".thumbnails .imgContainer").each(function(){$(this).find(".upload-image-tools").attr("style","width: 58px;");$(this).find(".upload-avatar").remove()});if($(".thumbnails .imgContainer:first").find(".upload-avatar").length<=0){$(".thumbnails .imgContainer:first").find(".upload-image-tools").attr("style","width: 145px;");$(".thumbnails .imgContainer:first").find(".upload-image-tools").append('<a href="javascript:void(0)" class="upload-avatar">'+bds_lang.UploadImageControl.AvatarImage+"</a>")}else{$(".thumbnails .imgContainer:first").find(".upload-avatar").html(bds_lang.UploadImageControl.AvatarImage)}$("#hddIsChanged").val(1)};