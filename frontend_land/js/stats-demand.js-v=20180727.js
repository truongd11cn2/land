function AddDemandToStorage(g){var b=g.split(",");if(b.length==6){var c=b[0];var d=b[1];var f=b[2];var a=b[3];if(a=="0"){a="-1"}var o=b[4];if(o=="0"){o="-1"}var p=b[5];var e=window.localStorage.getItem("demand");var q=window.sessionStorage.getItem("demand");if(e==undefined){e=[]}else{try{e=JSON.parse(e)}catch(h){e=[]}}if(q==undefined){q=[]}else{try{q=JSON.parse(q)}catch(h){q=[]}}var u=new Date();u.setHours(0,0,0,0);u=u.getTime();var n=_getPastDay(7);var t=[];for(var k=0;k<e.length;k++){if(e[k].day>=n){t.push(e[k])}}e=t;var j=false;for(var k=0;k<e.length;k++){var l=e[k];if(l.day==u&&l.cate==c&&l.city==d&&l.distr==f&&l.area==a&&l.price==o&&l.proj==p){l.count++;j=true;break}}var r=false;for(var k=0;k<q.length;k++){var l=q[k];if(l.day==u&&l.cate==c&&l.city==d&&l.distr==f&&l.area==a&&l.price==o&&l.proj==p){l.count++;r=true;break}}if(j==false){var m=0;if(a>0){m++}if(o>0){m++}if(p>0){m++}e.push({day:u,cate:c,city:d,distr:f,area:a,price:o,proj:p,level:m,count:1})}if(r==false){var m=0;if(a>0){m++}if(o>0){m++}if(p>0){m++}q.push({day:u,cate:c,city:d,distr:f,area:a,price:o,proj:p,level:m,count:1})}var s=JSON.stringify(e);window.localStorage.setItem("demand",s);s=JSON.stringify(q);window.sessionStorage.setItem("demand",s);return{demand:e,session:q}}return[]}function RemoveDemandFromStore(d,h,f){if(f){var a=window.localStorage.getItem("demand");if(a==undefined){a=[]}else{try{a=JSON.parse(a)}catch(c){a=[]}}var l=[];for(var e=0;e<a.length;e++){var g=a[e];if(g.cate==d.cate&&g.city==d.city&&g.distr==d.distr&&g.area==d.area&&g.price==d.price&&g.proj==d.proj){continue}else{l.push(g)}}var k=JSON.stringify(l);window.localStorage.setItem("demand",k);if(h==undefined||isNaN(h)){h=0}var n=_getPastDay(h);window.localStorage.setItem("popup",n)}var j=window.sessionStorage.getItem("demand");if(j==undefined){j=[]}else{try{j=JSON.parse(j)}catch(c){j=[]}}l=[];for(var e=0;e<j.length;e++){var g=j[e];if(g.cate==d.cate&&g.city==d.city&&g.distr==d.distr&&g.area==d.area&&g.price==d.price&&g.proj==d.proj){continue}else{l.push(g)}}k=JSON.stringify(l);window.sessionStorage.setItem("demand",l);var m=window.sessionStorage.getItem("popup");if(m==undefined||m==null){m=1}else{m=parseInt(m)+1}window.sessionStorage.setItem("popup",m);var b=window.sessionStorage.getItem("denined");if(b==undefined){b=[]}else{try{b=JSON.parse(b)}catch(c){b=[]}}b.push(d);strDenined=JSON.stringify(b);window.sessionStorage.setItem("denined",strDenined)}function _getRankDate(a){switch(a){case 0:return 2.2;case 1:return 2;case 2:return 1.8;case 3:return 1.6;case 4:return 1.4;case 5:return 1.2;case 6:return 1;case 7:return 1.8;default:return 0}}function _checkDeninedDemand(a,d){for(var b=0;b<a.length;b++){var c=a[b];if(c.cate==d.cate&&c.city==d.city&&c.distr==d.distr&&c.area==d.area&&c.price==d.price&&c.proj==d.proj){return true}}return false}function AggregateDemand(a){var h=[];var b=window.sessionStorage.getItem("denined");if(b==undefined){b=[]}else{try{b=JSON.parse(b)}catch(c){b=[]}}var l=_getPastDay(0);for(var e=0;e<a.length;e++){var f=a[e];f.rank=_getRankDate((Math.abs(f.day-l)/(1000*60*60*24)))*f.count;var d=false;if(f.area>0&&f.price>0&&f.proj>0){for(var g=0;g<h.length;g++){var k=h[g];if(f.day<=l&&f.cate==k.cate&&f.city==k.city&&f.distr==k.distr&&f.area==k.area&&f.price==k.price&&f.proj==k.proj){k.count+=f.count;k.rank+=f.rank;d=true}}if(d==false){if(_checkDeninedDemand(b,f)==false){h.push(f)}}}if(f.area>0&&f.price>0){d=false;for(var g=0;g<h.length;g++){var k=h[g];if(f.day<=l&&f.cate==k.cate&&f.city==k.city&&f.distr==k.distr&&f.area==k.area&&f.price==k.price&&k.proj==0){k.count+=f.count;k.rank+=f.rank;d=true}}if(d==false){var k={day:f.day,cate:f.cate,city:f.city,distr:f.distr,area:f.area,price:f.price,proj:0,level:2,count:f.count,rank:f.rank};if(_checkDeninedDemand(b,k)==false){h.push(k)}}}if(f.area>0&&f.proj>0){d=false;for(var g=0;g<h.length;g++){var k=h[g];if(f.day<=l&&f.cate==k.cate&&f.city==k.city&&f.distr==k.distr&&f.area==k.area&&k.price==-1&&k.proj==f.proj){k.count+=f.count;k.rank+=f.rank;d=true}}if(d==false){var k={day:f.day,cate:f.cate,city:f.city,distr:f.distr,area:f.area,price:-1,proj:f.proj,level:2,count:f.count,rank:f.rank};if(_checkDeninedDemand(b,k)==false){h.push(k)}}}if(f.price>0&&f.proj>0){d=false;for(var g=0;g<h.length;g++){var k=h[g];if(f.day<=l&&f.cate==k.cate&&f.city==k.city&&f.distr==k.distr&&k.area==-1&&k.price==f.price&&k.proj==f.proj){k.count+=f.count;k.rank+=f.rank;d=true}}if(d==false){var k={day:f.day,cate:f.cate,city:f.city,distr:f.distr,area:-1,price:f.price,proj:f.proj,level:2,count:f.count,rank:f.rank};if(_checkDeninedDemand(b,k)==false){h.push(k)}}}if(f.area>0){d=false;for(var g=0;g<h.length;g++){var k=h[g];if(f.day<=l&&f.cate==k.cate&&f.city==k.city&&f.distr==k.distr&&k.area==f.area&&k.price==-1&&k.proj==0){k.count+=f.count;k.rank+=f.rank;d=true}}if(d==false){var k={day:f.day,cate:f.cate,city:f.city,distr:f.distr,area:f.area,price:-1,proj:0,level:1,count:f.count,rank:f.rank};if(_checkDeninedDemand(b,k)==false){h.push(k)}}}if(f.price>0){d=false;for(var g=0;g<h.length;g++){var k=h[g];if(f.day<=l&&f.cate==k.cate&&f.city==k.city&&f.distr==k.distr&&k.area==-1&&k.price==f.price&&k.proj==0){k.count+=f.count;k.rank+=f.rank;d=true}}if(d==false){var k={day:f.day,cate:f.cate,city:f.city,distr:f.distr,area:-1,price:f.price,proj:0,level:1,count:f.count,rank:f.rank};if(_checkDeninedDemand(b,k)==false){h.push(k)}}}if(f.proj>0){d=false;for(var g=0;g<h.length;g++){var k=h[g];if(f.day<=l&&f.cate==k.cate&&f.city==k.city&&f.distr==k.distr&&k.area==-1&&k.price==-1&&k.proj==f.proj){k.count+=f.count;k.rank+=f.rank;d=true}}if(d==false){var k={day:f.day,cate:f.cate,city:f.city,distr:f.distr,area:-1,price:-1,proj:f.proj,level:1,count:f.count,rank:f.rank};if(_checkDeninedDemand(b,k)==false){h.push(k)}}}d=false;for(var g=0;g<h.length;g++){var k=h[g];if(f.day<=l&&f.cate==k.cate&&f.city==k.city&&f.distr==k.distr&&k.area==-1&&k.price==-1&&k.proj==0){k.count+=f.count;k.rank+=f.rank;d=true}}if(d==false){var k={day:f.day,cate:f.cate,city:f.city,distr:f.distr,area:-1,price:-1,proj:0,level:0,count:f.count,rank:f.rank};if(_checkDeninedDemand(b,k)==false){h.push(k)}}}return h}function _getPastDay(a){var b=new Date();b.setDate(b.getDate()-a);b.setHours(0,0,0,0);return b.getTime()}function FindDemand(d){var c=AggregateDemand(d.demand);var e=null;for(var a=0;a<c.length;a++){var b=c[a];if(b.count>20&&b.level>0||b.count>40&&b.level==0){if(e==null||b.level>e.level){e=b}else{if(e!=null&&e.level==b.level&&e.rank<b.rank){e=b}}}}if(e==null){c=AggregateDemand(d.session);for(var a=0;a<c.length;a++){var b=c[a];if(b.count>3&&b.level>0){if(e==null||e.level<b.level){e=b}else{if(e!=null&&e.level==b.level&&e.count<b.count){e=b}}}}}else{}return e}function _findDemandByDay(a){var h=AggregateDemand(a);var j=null;var f=0;var d=null;var g=0;var e=null;for(var b=0;b<h.length;b++){var c=h[b];if(c.level==0){if(f<c.count){f=c.count;d=c}}else{if(g<c.count){g=c.count;e=c}}if(c.count>20&&c.level>0||c.count>40&&c.level==0){if(j==null||c.level>j.level){j=c}else{if(j!=null&&j.level==c.level&&j.rank<c.rank){j=c}}}}if(d!=null){}if(e!=null){}return j}function _findDemandBySession(j){var g=AggregateDemand(j);var h=null;var e=0;var c=null;var f=0;var d=null;for(var a=0;a<g.length;a++){var b=g[a];if(b.level==0){if(e<b.count){e=b.count;c=b}}else{if(f<b.count){f=b.count;d=b}}if(b.count>3&&b.level>0){if(h==null||h.level<b.level){h=b}else{if(h!=null&&h.level==b.level&&h.count<b.count){h=b}}}}if(c!=null){}if(d!=null){}return h}function GetMatchingBroker(b,c,d,a,e,f){if($("#hidSecretkey").length>0){var g=$("form").attr("statsDomain")+"/StatisticServiceLibrary/getmatching/"+c+"/"+$("#hidSecretkey").val()+"?a={0}&b={1}&c={2}&d={3}&e={4}".format(b,d,a,e,f);$.ajax(g,{dataType:"json"}).done(function(h){if(h&&h.Ids.length>0){ShowPopupDemand({cate:b,city:c,distr:d,area:a,price:e,proj:f},h)}else{}}).fail(function(i,j,h){})}}function ShowPopupDemand(e,b){var g=false;var p=null;for(var h=0;h<cateList.length;h++){var q=cateList[h];for(var l=0;l<q.children.length;l++){var c=q.children[l];if(c.id==e.cate){$("#popup_ask_demand .popup-demand-content ul li:nth(0) span").text(c.name);g=true;break}}if(g){p=q.id;break}}for(var h=0;h<cityList.length;h++){var d=cityList[h];if(d.code==e.city){for(var l=0;l<d.district.length;l++){var f=d.district[l];if(f.id==e.distr){$("#popup_ask_demand .popup-demand-content ul li:nth(1) span").text(d.name+"/"+f.name);if(e.proj>0){for(var m=0;m<f.project.length;m++){var o=f.project[m];if(o.id==e.proj){$("#popup_ask_demand .popup-demand-content ul").append("<li><span>Dự án: "+o.name+"</span></li>");break}}}break}}break}}if(e.area>0){for(var h=0;h<areaLevel.length;h++){var a=areaLevel[h];if(a.id==e.area){$("#popup_ask_demand .popup-demand-content ul").append("<li><span>"+a.name+"</span></li>");break}}}if(p!=null&&e.price>0){g=false;for(var h=0;h<priceLevelByType.length;h++){if(priceLevelByType[h].code==p){for(var l=0;l<priceLevelByType[h].data.length;l++){var n=priceLevelByType[h].data[l];if(n.Name==e.price){$("#popup_ask_demand .popup-demand-content ul").append("<li><span>"+n.Value+"</span></li>");g=true;break}}}if(g){break}}}$("#popup_ask_demand").show();$("#popup_ask_demand").find(".active").click(function(){$("#popup_ask_demand").hide();$(".popup-demand-brokerinfo img").attr("src",b.avatar);$(".popup-demand-brokerinfo label").text(b.name);$(".popup-demand-brokerinfo span:nth(0)").text(b.email);$(".popup-demand-brokerinfo span:nth(1)").text(b.mobile);$("#popup_matching_demand").show()});$("#popup_ask_demand").find(".inactive").click(function(){$("#popup_ask_demand").hide();$("#popup_submit_demand").show();var u=$("#dmDivCategoryRe").AdvanceHiddenDropbox({id:"dmDivCatagoryReOptions",hddValue:"dmHdCboCatagoryRe",css:{position:"fixed",top:"auto",left:"auto",right:"340px",bottom:"0px"}});var s='<li vl="0" class="advance-options">--Chọn loại nhà đất--</li>';var A=38;for(var y=0;y<cateList.length;y++){var k=cateList[y].children;for(var z=0;z<k.length;z++){s+='<li class="advance-options" vl="'+k[z].id+'">'+k[z].name+"</li>";if(k[z].id==e.cate){A=cateList[y].id}}}u.UpdateOptions(s);u.SetValue(e.cate);var x=$("#dmDivPrice").AdvanceHiddenDropbox({id:"dmDivPriceOptions",hddValue:"dmHdCboPrice",css:{position:"fixed",top:"auto",left:"auto",right:"340px",bottom:"0px"}});s='<li vl="-1" class="advance-options">--Chọn mức giá--</li>';for(var y=0;y<priceLevelByType.length;y++){if(priceLevelByType[y].code==A){for(var z=0;z<priceLevelByType[y].data.length;z++){if(priceLevelByType[y].data[z].Name>0){s+='<li vl="'+priceLevelByType[y].data[z].Name+'" class="advance-options">'+priceLevelByType[y].data[z].Value+"</li>"}}break}}x.UpdateOptions(s);x.SetValue(e.price);u.BindChangeEvent({cat:u,price:x},function(B){var C=B.cat.GetValue();A=0;for(var E=0;E<cateList.length;E++){var D=cateList[E].children;for(var F=0;F<D.length;F++){if(D[F].id==C){A=cateList[E].id;break}}if(A>0){break}}var G='<li vl="-1" class="advance-options">--Chọn mức giá--</li>';for(var E=0;E<priceLevelByType.length;E++){if(priceLevelByType[E].code==A){for(var F=0;F<priceLevelByType[E].data.length;F++){if(priceLevelByType[E].data[F].Name>0){G+='<li vl="'+priceLevelByType[E].data[F].Name+'" class="advance-options">'+priceLevelByType[E].data[F].Value+"</li>"}}break}}B.price.UpdateOptions(G);B.price.SetValue(-1)});var v=$("#dmDivCity").AdvanceHiddenDropbox({id:"dmDivCityOptions",hddValue:"dmHdCboCity",css:{position:"fixed",top:"auto",left:"auto",right:"340px",bottom:"0px"}});s='<li vl="CN" class="advance-options">--Chọn Tỉnh/Thành phố--</li>';for(var y=0;y<cityList.length;y++){var r=cityList[y];s+='<li class="advance-options" vl="'+r.code+'">'+r.name+"</li>"}v.UpdateOptions(s);v.SetValue(e.city);var w=$("#dmDivDistrict").AdvanceHiddenDropbox({id:"dmDivDistrictOptions",hddValue:"dmHdCboDistrict",css:{position:"fixed",top:"auto",left:"auto",right:"340px",bottom:"0px"}});v.BindChangeEvent({cboCity:v,cboDistr:w},function(B){var D=B.cboCity.GetValue();var G='<li vl="0" class="advance-options">--Chọn Quận/Huyện--</li>';for(var E=0;E<cityList.length;E++){var C=cityList[E];if(C.code==D){for(var F=0;F<C.district.length;F++){G+="<li vl='"+C.district[F].id+'\' class="advance-options">'+C.district[F].name+"</li>"}break}}B.cboDistr.UpdateOptions(G);B.cboDistr.SetValue("0")});s='<li vl="0" class="advance-options">--Chọn Quận/Huyện--</li>';for(var y=0;y<cityList.length;y++){var r=cityList[y];if(r.code==e.city){for(var z=0;z<r.district.length;z++){s+="<li vl='"+r.district[z].id+'\' class="advance-options">'+r.district[z].name+"</li>"}break}}w.UpdateOptions(s);w.SetValue(e.distr);var t=$("#dmDivArea").AdvanceHiddenDropbox({id:"dmDivAreaOptions",hddValue:"dmHdCboArea",css:{position:"fixed",top:"auto",left:"auto",right:"340px",bottom:"0px"}});s='<li vl="-1" class="advance-options">--Chọn diện tích--</li>';for(var y=0;y<areaLevel.length;y++){if(areaLevel[y].id>0){s+='<li vl="'+areaLevel[y].id+'" class="advance-options">'+areaLevel[y].name+"</li>"}}t.UpdateOptions(s);t.SetValue(e.area)});$("#popup_matching_demand").find(".active").click(function(){$("#popup_matching_demand").hide();$("#popup_submit_info").show();$("#txtGuestFone").keydown(function(i){return numbersonly(this,i,false)})});$("#popup_matching_demand").find(".inactive").click(function(){RemoveDemandFromStore(e,0,true);$("#popup_matching_demand").hide()});$("#popup_submit_demand").find(".active").click(function(){RemoveDemandFromStore(e,0,true);$("#popup_submit_demand").hide();$("#popup_submit_info").show()});$("#popup_submit_info").find(".active").click(function(){var v="";for(var k=0;k<b.Ids.length;k++){var r=b.Ids[k];if(v.length>0){v+=","}v+=r}var t=$("#txtGuestName").val();var j=$("#txtGuestEmail").val();var s=$("#txtGuestFone").val();var u=$("#txtGuestOtherInfo").val();if(t.length==0){alert("Bạn cần nhập tên");return}if(s.length==0){alert("Bạn cần nhập số điện thoại");return}if(j.length==0){alert("Bạn cần nhập email");return}if(u.length==0){u=" "}var w=$("form").attr("statsDomain")+"/StatisticServiceLibrary/notifydemand/{0}/{1}/{2}/{3}/{4}/{5}/{6}/{7}/{8}/{9}/{10}/{11}".format(v,t,j,s,u,e.cate,e.city,e.distr,e.area,e.price,e.proj,b.key);$.get(w,function(i){});$("#popup_submit_info").hide();RemoveDemandFromStore(e,-7,true)});$(".popup-demand-close").click(function(){RemoveDemandFromStore(e,0,false);$(".popup-demand").hide()})}function TrackingDemand(){if(typeof(Storage)!=="undefined"){var a=$("form").attr("dm");if(a!=undefined){var d=AddDemandToStorage(a);var c=window.localStorage.getItem("popup");if(c!=undefined){c=parseFloat(c);var e=_getPastDay(0);if(e<=c){return}}c=window.sessionStorage.getItem("popup");if(c!=undefined){c=parseInt(c);if(c>=2){return}}if(d!=null){var b=_findDemandByDay(d.demand);if(b==null){if(window.sessionStorage.getItem("startTime")==undefined){window.sessionStorage.setItem("startTime",new Date().getTime());return}else{if(new Date().getTime()-parseFloat(window.sessionStorage.getItem("startTime"))<120000){return}}b=_findDemandBySession(d.session);if(b!=null){}}else{}if(b!=null){GetMatchingBroker(b.cate,b.city,b.distr,b.area,b.price,b.proj)}}}}}$(function(){if(typeof(Storage)!=="undefined"){var a=window.localStorage.getItem("broker");if(a!=1&&$(".popup-demand").length>0){TrackingDemand()}}});