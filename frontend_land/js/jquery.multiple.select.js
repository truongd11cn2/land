(function(a){function b(c,f){var g=this,e=c.attr("name")||f.name||"",d=c.outerWidth();this.$el=c.hide();this.options=f;this.$parent=a('<div class="ms-parent"></div>');this.$choice=a('<button type="button" class="ms-choice"><span class="placeholder">'+f.placeholder+"</span><div></div></button>");this.$drop=a('<div class="ms-drop '+f.position+'"></div>');if(typeof(f.dropWidth)=="number"){this.$drop.css("width",f.dropWidth)}this.$el.after(this.$parent);this.$parent.append(this.$choice);this.$parent.append(this.$drop);if(this.$el.prop("disabled")){this.$choice.addClass("disabled")}this.$parent.css("width",f.width||d);this.selectAllName='name="selectAll'+e+'"';this.selectGroupName='name="selectGroup'+e+'"';this.selectItemName='name="selectItem'+e+'"'}b.prototype={constructor:b,init:function(){var d=this,c=[];if(this.options.filter){c.push('<div class="ms-search">','<input type="text" autocomplete="off" autocorrect="off" autocapitilize="off" spellcheck="false">',"</div>")}c.push("<ul>");if(this.options.selectAll&&!this.options.single){c.push("<li>","<label>",'<input type="checkbox" '+this.selectAllName+" /> ","["+this.options.selectAllText+"]","</label>","</li>")}a.each(this.$el.children(),function(f,e){if(d.options.hiddenFirstItem&&f==0){return}c.push(d.optionToHtml(f,e))});c.push('<li class="ms-no-results">'+this.options.noMatchesFound+"</li>");c.push("</ul>");this.$drop.html(c.join(""));this.$drop.find("ul").css("max-height",this.options.maxHeight+"px");this.$drop.find(".multiple").css("width",this.options.multipleWidth+"px");this.$searchInput=this.$drop.find(".ms-search input");this.$selectAll=this.$drop.find("input["+this.selectAllName+"]");this.$selectGroups=this.$drop.find("input["+this.selectGroupName+"]");this.$selectItems=this.$drop.find("input["+this.selectItemName+"]:enabled");this.$disableItems=this.$drop.find("input["+this.selectItemName+"]:disabled");this.$noResults=this.$drop.find(".ms-no-results");this.events();this.update(true);if(this.options.isOpen){this.open()}},optionToHtml:function(k,f,g,h){var q=this,c=a(f),j=[],m=this.options.multiple,e,r=this.options.single?"radio":"checkbox";if(c.is("option")){var s=c.val(),p=c.text(),n=(q.$el.attr("multiple")!=undefined)?c.prop("selected"):(c.attr("selected")=="selected"),o=this.options.styler(s)?' style="'+this.options.styler(s)+'"':"";e=h||c.prop("disabled");if((this.options.blockSeparator>"")&&(this.options.blockSeparator==c.val())){j.push("<li"+(m?' class="multiple"':"")+o+">",'<label class="'+this.options.blockSeparator+(e?"disabled":"")+'" title="'+p+'">',p,"</label>","</li>")}else{j.push("<li"+(m?' class="multiple"':"")+o+">","<label"+(e?' class="disabled"':"")+' title="'+p+'">','<input type="'+r+'" '+this.selectItemName+' value="'+s+'"'+(n?' checked="checked"':"")+(e?' disabled="disabled"':"")+(g?' data-group="'+g+'"':"")+"/> ",p,"</label>","</li>")}}else{if(!g&&c.is("optgroup")){var d="group_"+k,l=c.attr("label");e=c.prop("disabled");if(q.options.hiddenFirstItem&&k!=1||!q.options.hiddenFirstItem&&k!=0){j.push('<li class="group-sep"></li>')}if(q.options.allowCheckGroup){j.push('<li class="group">','<label class="optgroup'+(e?" disabled":"")+'" data-group="'+d+'">','<input type="checkbox" '+this.selectGroupName+(e?' disabled="disabled"':"")+" /> ",l,"</label>","</li>")}else{j.push('<li class="group">','<label class="optgroup'+(e?" disabled":"")+'" data-group="'+d+'">',l,"</label>","</li>")}a.each(c.children(),function(u,t){j.push(q.optionToHtml(u,t,d,e))})}}return j.join("")},events:function(){var c=this;this.$choice.off("click").on("click",function(d){d.preventDefault();c[c.options.isOpen?"close":"open"]();if(!c.options.keepOpen){if(c.options.isOpen){a("body").unbind("click").click(function(f){if(a(f.target)[0]===c.$choice[0]||a(f.target).parents(".ms-choice")[0]===c.$choice[0]||a(f.target)===c.$drop[0]||a(f.target).parents(".ms-drop")[0]===c.$drop[0]){return}if((a(f.target)[0]===c.$drop[0]||a(f.target).parents(".ms-drop")[0]!==c.$drop[0])&&c.options.isOpen){c.close();a("body").unbind("click")}})}}}).off("focus").on("focus",this.options.onFocus).off("blur").on("blur",this.options.onBlur);this.$parent.off("keydown").on("keydown",function(d){switch(d.which){case 27:c.close();c.$choice.focus();break}});this.$searchInput.off("keydown").on("keydown",function(d){if(d.keyCode===9&&d.shiftKey){c.close()}}).off("keyup").on("keyup",function(d){if(c.options.filterAcceptOnEnter&&(d.which===13||d.which==32)&&c.$searchInput.val()){c.$selectAll.click();c.close();c.focus();return}c.filter()});this.$selectAll.off("click").on("click",function(){var e=a(this).prop("checked"),d=c.$selectItems.filter(":visible");if(d.length===c.$selectItems.length){c[e?"checkAll":"uncheckAll"]()}else{c.$selectGroups.prop("checked",e);d.prop("checked",e);c.options[e?"onCheckAll":"onUncheckAll"]();c.update()}});this.$selectGroups.off("click").on("click",function(){var g=a(this).parent().attr("data-group"),e=c.$selectItems.filter(":visible"),d=e.filter('[data-group="'+g+'"]'),f=d.length!==d.filter(":checked").length;d.prop("checked",f);c.updateSelectAll();c.update();c.options.onOptgroupClick({label:a(this).parent().text(),checked:f,children:d.get()})});this.$selectItems.off("click").on("click",function(){if(c.options.maxChecked==undefined||c.options.maxChecked<=0||c.getSelects("checkbox").length<=c.options.maxChecked){c.updateSelectAll();c.update();c.updateOptGroupSelect();c.options.onClick({label:a(this).parent().text(),value:a(this).val(),checked:a(this).prop("checked")});if(c.options.single&&c.options.isOpen&&!c.options.keepOpen){c.close()}if(c.options.maxChecked==undefined||c.options.maxChecked<=0||c.getSelects("checkbox").length<c.options.maxChecked){c.$drop.find("input['checkbox']:not(:checked)").each(function(){a(this).prop("disabled",false)})}else{c.$drop.find("input['checkbox']:not(:checked)").each(function(){a(this).prop("disabled",true)})}}else{a(this).prop("checked",false);c.$drop.find("input['checkbox']:not(:checked)").each(function(){a(this).prop("disabled",true)})}})},open:function(){if(this.$choice.hasClass("disabled")){return}a(".ms-parent .ms-drop").hide();this.options.isOpen=true;this.$choice.find(">div").addClass("open");this.$drop.show();this.$selectAll.parent().show();this.$noResults.hide();if(this.$el.children().length===0){this.$selectAll.parent().hide();this.$noResults.show()}if(this.options.container){var c=this.$drop.offset();this.$drop.appendTo(a(this.options.container));this.$drop.offset({top:c.top,left:c.left})}if(this.options.filter){this.$searchInput.val("");this.$searchInput.focus();this.filter()}this.options.onOpen()},close:function(){this.options.isOpen=false;this.$choice.find(">div").removeClass("open");this.$drop.hide();if(this.options.container){this.$parent.append(this.$drop);this.$drop.css({top:"auto",left:"auto"})}this.options.onClose()},update:function(d){var e=this.getSelects(),c=this.$choice.find(">span");if(e.length===0){c.addClass("placeholder").html(this.options.placeholder);c.parent().removeAttr("title")}else{if(this.options.minumimCountSelected===-1){c.removeClass("placeholder").html(this.getSelects("text").join(", "))}else{if(this.options.countSelected&&e.length<this.options.minumimCountSelected){c.removeClass("placeholder").html(this.getSelects("text").join(", "))}else{if(this.options.allSelected&&e.length===this.$selectItems.length+this.$disableItems.length){c.removeClass("placeholder").html(this.options.allSelected)}else{if(this.options.countSelected&&e.length>this.options.minumimCountSelected){c.removeClass("placeholder").html(this.options.countSelected.replace("#",e.length).replace("%",this.$selectItems.length+this.$disableItems.length))}else{c.removeClass("placeholder").html(this.getSelects("text").join(", "))}}}}c.parent().attr("title",c.text())}this.$el.val(this.getSelects());if(!d){this.$el.trigger("change")}},updateSelectAll:function(){var c=this.$selectItems.filter(":visible");this.$selectAll.prop("checked",c.length&&c.length===c.filter(":checked").length);if(this.$selectAll.prop("checked")){this.options.onCheckAll()}},updateOptGroupSelect:function(){var c=this.$selectItems.filter(":visible");a.each(this.$selectGroups,function(f,g){var e=a(g).parent().attr("data-group"),d=c.filter('[data-group="'+e+'"]');a(g).prop("checked",d.length&&d.length===d.filter(":checked").length)})},getSelects:function(e){var d=this,c=[],f=[];this.$drop.find("input["+this.selectItemName+"]:checked").each(function(){c.push(a(this).parent().text());f.push(a(this).val())});if(e==="text"&&this.$selectGroups.length){c=[];this.$selectGroups.each(function(){var j=[],l=a.trim(a(this).parent().text()),i=a(this).parent().data("group"),g=d.$drop.find("["+d.selectItemName+'][data-group="'+i+'"]'),h=g.filter(":checked");if(h.length===0){return}j.push("[");j.push(l);if(g.length>h.length){var k=[];h.each(function(){k.push(a(this).parent().text())});j.push(": "+k.join(", "))}j.push("]");c.push(j.join(""))})}return e==="text"?c:f},setSelects:function(d){var c=this;this.$selectItems.prop("checked",false);a.each(d,function(e,f){c.$selectItems.filter('[value="'+f+'"]').prop("checked",true)});this.$selectAll.prop("checked",this.$selectItems.length===this.$selectItems.filter(":checked").length);this.update()},enable:function(){this.$choice.removeClass("disabled")},disable:function(){this.$choice.addClass("disabled")},checkAll:function(){this.$selectItems.prop("checked",true);this.$selectGroups.prop("checked",true);this.$selectAll.prop("checked",true);this.update();this.options.onCheckAll()},uncheckAll:function(){this.$selectItems.prop("checked",false);this.$selectGroups.prop("checked",false);this.$selectAll.prop("checked",false);this.update();this.options.onUncheckAll()},focus:function(){this.$choice.focus();this.options.onFocus()},blur:function(){this.$choice.blur();this.options.onBlur()},refresh:function(){this.init()},filter:function(){var d=this,c=a.trim(this.$searchInput.val()).toLowerCase();if(c.length===0){this.$selectItems.parent().show();this.$disableItems.parent().show();this.$selectGroups.parent().show()}else{this.$selectItems.each(function(){var e=a(this).parent();e[e.text().toLowerCase().indexOf(c)<0?"hide":"show"]()});this.$disableItems.parent().hide();this.$selectGroups.each(function(){var f=a(this).parent();var g=f.attr("data-group"),e=d.$selectItems.filter(":visible");f[e.filter('[data-group="'+g+'"]').length===0?"hide":"show"]()});if(this.$selectItems.filter(":visible").length){this.$selectAll.parent().show();this.$noResults.hide()}else{this.$selectAll.parent().hide();this.$noResults.show()}}this.updateOptGroupSelect();this.updateSelectAll()}};a.fn.multipleSelect=function(){var e=arguments[0],d=arguments,f,c=["getSelects","setSelects","enable","disable","checkAll","uncheckAll","focus","blur","refresh"];this.each(function(){var g=a(this),h=g.data("multipleSelect"),i=a.extend({},a.fn.multipleSelect.defaults,g.data(),typeof e==="object"&&e);if(!h){h=new b(g,i);g.data("multipleSelect",h)}if(typeof e==="string"){if(a.inArray(e,c)<0){throw"Unknown method: "+e}f=h[e](d[1])}else{h.init();if(d[1]){f=h[d[1]].apply(h,[].slice.call(d,2))}}});return f?f:this};a.fn.multipleSelect.defaults={name:"",isOpen:false,placeholder:"",selectAll:true,selectAllText:"Select all",allSelected:"All selected",minumimCountSelected:3,countSelected:"# of % selected",noMatchesFound:"No matches found",multiple:false,multipleWidth:80,single:false,filter:false,width:undefined,maxHeight:250,container:null,position:"bottom",keepOpen:false,blockSeparator:"",hiddenFirstItem:false,dropWidth:"auto",allowCheckGroup:true,maxChecked:-1,styler:function(){return false},onOpen:function(){return false},onClose:function(){return false},onCheckAll:function(){return false},onUncheckAll:function(){return false},onFocus:function(){return false},onBlur:function(){return false},onOptgroupClick:function(){return false},onClick:function(){return false}}})(jQuery);